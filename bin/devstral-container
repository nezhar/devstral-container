#!/usr/bin/env bash

set -e

# Configuration
CONFIG_DIR="${HOME}/.config/devstral-container"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to show usage
show_usage() {
    cat << EOF
Usage: devstral-container [OPTIONS] [COMMAND]

Run Devstral Vibe CLI in a containerized environment with optional API logging.

OPTIONS:
    --proxy         Enable API request/response logging via proxy
    --no-proxy      Disable proxy (default)
    --datasette     Start Datasette web interface for viewing logs (implies --proxy)
    -h, --help      Show this help message

COMMAND:
    Any command to pass to vibe CLI (default: interactive mode)

EXAMPLES:
    devstral-container                    # Interactive mode without logging
    devstral-container --proxy            # Interactive mode with API logging
    devstral-container --datasette        # Interactive mode with logging and web UI
    devstral-container "analyze the code" # Run specific command

EOF
}

# Parse arguments
ENABLE_PROXY=false
ENABLE_DATASETTE=false
VIBE_COMMAND=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --proxy)
            ENABLE_PROXY=true
            shift
            ;;
        --no-proxy)
            ENABLE_PROXY=false
            shift
            ;;
        --datasette)
            ENABLE_PROXY=true
            ENABLE_DATASETTE=true
            shift
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        *)
            VIBE_COMMAND="$1"
            shift
            ;;
    esac
done

# Create config directory if it doesn't exist
mkdir -p "${CONFIG_DIR}/config"
mkdir -p "${CONFIG_DIR}/proxy"

# Store the original working directory before changing to project dir
export WORKSPACE_DIR="${PWD}"

# Build profiles argument
PROFILES=""
if [[ "$ENABLE_PROXY" == true ]]; then
    PROFILES="--profile proxy"
    export PROXY_ENABLED="http://devstral-proxy:8080"

    echo -e "${GREEN}Starting with API logging enabled${NC}"

    if [[ "$ENABLE_DATASETTE" == true ]]; then
        echo -e "${GREEN}Datasette will be available at http://localhost:8001${NC}"
    fi
else
    export PROXY_ENABLED=""
fi

# Set image details
VERSION="${DEVSTRAL_CONTAINER_VERSION:-0.1.0}"
IMAGE="nezhar/devstral-cli:${VERSION}"
PROXY_IMAGE="nezhar/devstral-proxy:${VERSION}"
DATASETTE_IMAGE="nezhar/devstral-datasette:${VERSION}"
NETWORK_NAME="devstral-network"
PROXY_CONTAINER_NAME="devstral-proxy"
DATASETTE_CONTAINER_NAME="devstral-datasette"

# Start background services if needed
if [[ "$ENABLE_PROXY" == true ]]; then
    echo -e "${YELLOW}Starting proxy services...${NC}"

    # Create network if it doesn't exist
    docker network create "$NETWORK_NAME" 2>/dev/null || true

    # Start proxy container
    docker run -d --rm \
        --name "$PROXY_CONTAINER_NAME" \
        --network "$NETWORK_NAME" \
        -p 8080:8080 \
        -v "${CONFIG_DIR}/proxy:/root/.mitmproxy" \
        -v "${CONFIG_DIR}/proxy:/proxy/logs" \
        "$PROXY_IMAGE" 2>/dev/null || true

    if [[ "$ENABLE_DATASETTE" == true ]]; then
        # Start datasette container
        docker run -d --rm \
            --name "$DATASETTE_CONTAINER_NAME" \
            --network "$NETWORK_NAME" \
            -p 8001:8001 \
            -v "${CONFIG_DIR}/proxy:/data" \
            "$DATASETTE_IMAGE" 2>/dev/null || true

        echo -e "${GREEN}Datasette will be available at http://localhost:8001${NC}"
    fi

    # Wait for proxy to be ready
    sleep 2
fi

# Prepare docker run command
DOCKER_ARGS=(
    --rm -it
    -v "${WORKSPACE_DIR}:/workspace"
    -v "${CONFIG_DIR}/config:/root/.vibe"
    -e "USER_UID=$(id -u)"
    -e "USER_GID=$(id -g)"
)

# Add proxy configuration if enabled
if [[ "$ENABLE_PROXY" == true ]]; then
    DOCKER_ARGS+=(
        --network "$NETWORK_NAME"
        -e "HTTPS_PROXY=http://${PROXY_CONTAINER_NAME}:8080"
    )
fi

# Run the CLI
if [[ -z "$VIBE_COMMAND" ]]; then
    # Interactive mode
    docker run "${DOCKER_ARGS[@]}" "$IMAGE"
else
    # Command mode
    docker run "${DOCKER_ARGS[@]}" "$IMAGE" vibe "$VIBE_COMMAND"
fi

# Cleanup
if [[ "$ENABLE_PROXY" == true ]]; then
    echo -e "${YELLOW}Proxy services are still running. To stop them, run:${NC}"
    echo -e "${YELLOW}  docker stop $PROXY_CONTAINER_NAME${NC}"
    if [[ "$ENABLE_DATASETTE" == true ]]; then
        echo -e "${YELLOW}  docker stop $DATASETTE_CONTAINER_NAME${NC}"
    fi
fi
