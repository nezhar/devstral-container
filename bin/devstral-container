#!/usr/bin/env bash

set -e

# Configuration
CONFIG_DIR="${HOME}/.config/devstral-container"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to show usage
show_usage() {
    cat << EOF
Usage: devstral-container [OPTIONS] [COMMAND]

Run Devstral Vibe CLI in a containerized environment with optional API logging.

OPTIONS:
    --proxy         Enable API request/response logging via proxy
    --no-proxy      Disable proxy (default)
    --datasette     Start Datasette web interface for viewing logs (implies --proxy)
    --build         Force rebuild of Docker images
    -h, --help      Show this help message

COMMAND:
    Any command to pass to vibe CLI (default: interactive mode)

EXAMPLES:
    devstral-container                    # Interactive mode without logging
    devstral-container --proxy            # Interactive mode with API logging
    devstral-container --datasette        # Interactive mode with logging and web UI
    devstral-container "analyze the code" # Run specific command
    devstral-container --build            # Rebuild images and start

EOF
}

# Parse arguments
ENABLE_PROXY=false
ENABLE_DATASETTE=false
BUILD_FLAG=""
VIBE_COMMAND=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --proxy)
            ENABLE_PROXY=true
            shift
            ;;
        --no-proxy)
            ENABLE_PROXY=false
            shift
            ;;
        --datasette)
            ENABLE_PROXY=true
            ENABLE_DATASETTE=true
            shift
            ;;
        --build)
            BUILD_FLAG="--build"
            shift
            ;;
        -h|--help)
            show_usage
            exit 0
            ;;
        *)
            VIBE_COMMAND="$1"
            shift
            ;;
    esac
done

# Create config directory if it doesn't exist
mkdir -p "${CONFIG_DIR}/config"
mkdir -p "${CONFIG_DIR}/proxy"

# Build profiles argument
PROFILES=""
if [[ "$ENABLE_PROXY" == true ]]; then
    PROFILES="--profile proxy"
    export PROXY_ENABLED="http://devstral-proxy:8080"

    echo -e "${GREEN}Starting with API logging enabled${NC}"

    if [[ "$ENABLE_DATASETTE" == true ]]; then
        echo -e "${GREEN}Datasette will be available at http://localhost:8001${NC}"
    fi
else
    export PROXY_ENABLED=""
fi

# Change to project directory
cd "$PROJECT_DIR"

# Start background services if needed
if [[ "$ENABLE_PROXY" == true ]]; then
    echo -e "${YELLOW}Starting proxy services...${NC}"
    docker compose $PROFILES up -d $BUILD_FLAG devstral-proxy

    if [[ "$ENABLE_DATASETTE" == true ]]; then
        docker compose $PROFILES up -d $BUILD_FLAG devstral-datasette
    fi

    # Wait for proxy to be ready
    sleep 2
fi

# Build CLI image if needed
if [[ -n "$BUILD_FLAG" ]]; then
    echo -e "${YELLOW}Building devstral-cli image...${NC}"
    docker compose build devstral-cli
fi

# Run the CLI
if [[ -z "$VIBE_COMMAND" ]]; then
    # Interactive mode
    docker compose run --rm devstral-cli
else
    # Command mode
    docker compose run --rm devstral-cli vibe "$VIBE_COMMAND"
fi

# Cleanup
if [[ "$ENABLE_PROXY" == true ]]; then
    echo -e "${YELLOW}Proxy services are still running. To stop them, run:${NC}"
    echo -e "${YELLOW}  docker compose --profile proxy down${NC}"
fi
